<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Replay Viewer</title>
    <style>

    </style>
  </head>
  <body>
    <div id="file-input-container" class="hidden">
      <div id="dropbox">Drop a replay file here or <input type="file" id="file-input" value="" autocomplete="off"></div>
    </div>
    
    <script src="replayviewer.js"></script>
    <script type='text/javascript'>
if(window.FileReader) {
  document.getElementById("file-input").addEventListener("change", fileselect, false);
}
function fileselect() {
  handleFiles(this.files);
}

var fileData;
function handleFiles(files) {
  var fileList = files; /* now you can work with the file list */
  var reader = new FileReader();
  file = files[0];
  console.log(file);
  reader.onload = function(e) {
    console.log('file read', reader.result.slice(0, 8));
    fileData = reader.result;
    setTimeout(function () {
      writeFile(file.name, fileData);
      console.log('parser', parser, file.name);
      parser.open(file.name);
      //parser.readHeader();
      //console.log(parser.getCurrentTickState());
      parser.replayTick = 1000;
      console.log(parser.getCurrentTickState());
      /*var c = 0;
      while (parser.good()) {
        parser.read();
        //console.log(parser.tick);
        //console.log(parser.packetEntities);
        //console.log(parser.packetEntities.size());
        //console.log(parser.getPacketEntities2());
        //console.log(parser.getPacketEntitiesSize());
        //console.log(parser.getPacketEntities2().size());
        var packetEntities = parser.getPacketEntities();
        //console.log(packetEntities.size());
        for (var i = 0; i < packetEntities.size(); i++) {
            var el = packetEntities.get(i);
            
            if (el.className.startsWith("CDOTA_Unit_Hero_")) {
                var lifeState = el.getUint64("m_lifeState");
                console.log(el.className, lifeState);
            }
            
            var properties = el.getProperties();
            for (var j = 0; j < 10; j++) {
                var playerName = el.getString("m_vecPlayerData.000" + j + ".m_iszPlayerName");
                //if (playerName) console.log(playerName);
            }
            if (properties.hasString("m_vecPlayerData.0000.m_iszPlayerName")) {
                console.log(el.getString("m_vecPlayerData.0000.m_iszPlayerName"));
            }
            properties.delete();
            el.delete();
            //console.log(el.index);
        }
        packetEntities.delete();
        //if (c == 200) break;
        c++;
      }*/
      console.log('done');
    }, 0);
  }
  reader.readAsArrayBuffer(file);
}

function writeFile(fileName, fileData) {
  var stream = FS.open(fileName, 'w+');
  var data = new Uint8Array(fileData);
  console.log('data length', data.length);
  FS.write(stream, data, 0, data.length, 0);
  FS.close(stream);
  console.log(fileName, 'written');
}


        /*(function() {
          var memoryInitializer = 'replayviewer.js.mem';
          if (typeof Module['locateFile'] === 'function') {
            memoryInitializer = Module['locateFile'](memoryInitializer);
          } else if (Module['memoryInitializerPrefixURL']) {
            memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
          }
          var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
          xhr.open('GET', memoryInitializer, true);
          xhr.responseType = 'arraybuffer';
          xhr.send(null);
        })();*/
        
    console.log(Module);
    var parser = new Module['ReplayViewer']();
    console.log(parser);
</script>
  </body>
</html>
